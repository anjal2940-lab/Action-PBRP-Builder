name: Recovery Build

on:
  workflow_dispatch:
    inputs:
      MANIFEST_URL:
        description: 'PBRP Manifest'
        required: true
        default: 'https://github.com/PitchBlackRecoveryProject/manifest_pb'
      MANIFEST_BRANCH:
        description: 'Branch'
        required: true
        default: 'android-12.1'
      DEVICE_TREE_URL:
        description: 'Device Tree URL'
        required: true
        default: 'https://github.com/kawaldhanju33062-tech/twrp_device_samsung_m14x'
      DEVICE_TREE_BRANCH:
        description: 'Device Tree Branch'
        required: true
        default: 'twrp-12.1'
      DEVICE_PATH:
        description: 'DEVICE_PATH'
        required: true
        default: 'device/samsung/m14x'
      COMMON_TREE_URL:
        description: 'COMMON_TREE_URL'
        required: true
        default: 'https://github.com/kawaldhanju33062-tech/twrp_device_samsung_s5e8535-common'
      COMMON_PATH:
        description: 'COMMON_PATH'
        required: true
        default: 'device/samsung/s5e8535-common'
      DEVICE_NAME:
        description: 'DEVICE_NAME'
        required: true
        default: 'm14x'
      MAKEFILE_NAME:
        description: 'MAKEFILE_NAME (Matches PRODUCT_NAME)'
        required: true
        default: 'pb_m14x'
      BUILD_TARGET:
        description: 'Target (pbrp or recovery)'
        required: true
        default: 'pbrp'

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
    - name: Check Out
      uses: actions/checkout@v4

    - name: Cleanup Workspace (Aggressive)
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL /usr/local/share/boost
        sudo docker image prune --all --force
        sudo apt-get clean

    - name: Prepare Build Environment
      run: |
        sudo apt update && sudo apt install git aria2 -y
        git clone https://gitlab.com/OrangeFox/misc/scripts scripts_dir
        cd scripts_dir
        sudo bash setup/android_build_env.sh
        sed -i 's/cd -/cd ..\/..\//g' setup/install_android_sdk.sh
        sudo bash setup/install_android_sdk.sh

    - name: Install Repo
      run: |
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        sudo ln -sf ~/bin/repo /usr/bin/repo
      
    - name: Initialize Source
      run: |
        mkdir workspace && cd workspace
        git config --global user.name "Ansh"
        git config --global user.email "ansh@pbrp.com"
        # Using blob:none filter is mandatory to stay under 30GB
        repo init --depth=1 -u ${{ github.event.inputs.MANIFEST_URL }} -b ${{ github.event.inputs.MANIFEST_BRANCH }} --filter=blob:none
          
    - name: Repo Sync
      run: |
        repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags
      working-directory: workspace
      
    - name: Clone Trees
      run: |
        git clone ${{ github.event.inputs.DEVICE_TREE_URL }} -b ${{ github.event.inputs.DEVICE_TREE_BRANCH }} workspace/${{ github.event.inputs.DEVICE_PATH }}
        # Note the capital 'A' in Android-12.1 for the common tree
        git clone ${{ github.event.inputs.COMMON_TREE_URL }} -b Android-12.1 workspace/${{ github.event.inputs.COMMON_PATH }}

    - name: Maximize Space BEFORE Build
      run: |
        # Crucial Step: Delete the hidden .repo metadata folder (~15GB) 
        # because the build process (out/ folder) needs that space.
        rm -rf workspace/.repo
        df -h

    - name: Set Swap
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 12

    - name: Building PBRP
      run: |
        cd workspace
        source build/envsetup.sh
        export ALLOW_MISSING_DEPENDENCIES=true
        export LC_ALL=C
        lunch ${{ github.event.inputs.MAKEFILE_NAME }}-eng
        mka ${{ github.event.inputs.BUILD_TARGET }} -j$(nproc --all)

    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      with:
        files: | 
          workspace/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/PitchBlack*.zip
          workspace/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/recovery.img
        name: PBRP-${{ github.event.inputs.DEVICE_NAME }}-${{ github.run_id }}
        tag_name: ${{ github.run_id }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
